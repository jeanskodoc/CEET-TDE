<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me d'Authentification - CEET/TDE Togo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --ceet-color: #1a5276;
            --tde-color: #27ae60;
            --ceet-light: #3498db;
            --tde-light: #2ecc71;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #343a40;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark-gray);
            line-height: 1.6;
            min-height: 100vh;
            padding: 10px;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 5px;
        }
        
        .hidden {
            display: none;
        }
        
        /* Styles pour l'authentification */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
        }
        
        .auth-card {
            background: white;
            padding: 25px 20px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 100%;
            text-align: center;
        }
        
        .auth-header {
            margin-bottom: 20px;
        }
        
        .auth-logo {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .auth-title {
            font-size: 1.5rem;
            color: var(--ceet-color);
            margin-bottom: 8px;
        }
        
        .auth-subtitle {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--ceet-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--ceet-color), var(--ceet-light));
            color: white;
        }
        
        .btn-primary:hover, .btn-primary:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--tde-color), var(--tde-light));
            color: white;
        }
        
        .service-selector {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .service-option {
            border: 2px solid var(--medium-gray);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .service-option:active {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .service-option.selected {
            border-color: var(--ceet-color);
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }
        
        .service-option.tde.selected {
            border-color: var(--tde-color);
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        }
        
        .service-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .service-option.ceet .service-icon {
            color: var(--ceet-color);
        }
        
        .service-option.tde .service-icon {
            color: var(--tde-color);
        }
        
        .service-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .service-desc {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .error-message {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            padding: 10px 12px;
            border-radius: 6px;
            margin-top: 12px;
            border-left: 3px solid var(--danger);
            display: none;
            font-size: 0.85rem;
        }
        
        /* Styles pour l'application principale */
        header {
            background: linear-gradient(135deg, var(--ceet-color), var(--tde-color));
            color: white;
            padding: 15px 10px;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--ceet-light), var(--tde-light));
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .header-logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .header-logo i {
            font-size: 1.5rem;
        }
        
        .ceet-header-logo {
            color: var(--ceet-color);
        }
        
        .tde-header-logo {
            color: var(--tde-color);
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            margin-top: 10px;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .user-role {
            font-size: 0.75rem;
            opacity: 0.9;
        }
        
        .form-container {
            background: white;
            padding: 20px 15px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }
        
        .form-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--medium-gray);
        }
        
        .form-header i {
            font-size: 1.5rem;
            color: var(--ceet-color);
        }
        
        .form-title {
            font-size: 1.3rem;
            color: var(--ceet-color);
            font-weight: 600;
        }
        
        .form-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .section-header i {
            font-size: 1.2rem;
            color: var(--ceet-color);
        }
        
        .section-title {
            font-size: 1.2rem;
            color: var(--ceet-color);
            font-weight: 600;
        }
        
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-field {
            width: 100%;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.9rem;
        }
        
        .required::after {
            content: " *";
            color: var(--danger);
        }
        
        select, input, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--ceet-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .radio-option input {
            width: auto;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--ceet-color);
            color: var(--ceet-color);
        }
        
        .btn-outline:hover, .btn-outline:active {
            background-color: var(--ceet-color);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e74c3c);
            color: white;
            border: none;
        }
        
        .btn-danger:hover, .btn-danger:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.4);
        }
        
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .success-message {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            border-left: 4px solid var(--success);
            font-size: 0.9rem;
        }
        
        .location-help {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            border-left: 4px solid var(--ceet-color);
            font-size: 0.85rem;
        }
        
        .location-examples {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 8px;
        }
        
        .location-example {
            background: white;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--medium-gray);
        }
        
        .location-example:active {
            background: var(--ceet-light);
            color: white;
            transform: translateY(-1px);
        }
        
        .map-container {
            height: 300px;
            background-color: var(--medium-gray);
            border-radius: 8px;
            margin-top: 12px;
            overflow: hidden;
            border: 2px solid var(--medium-gray);
            position: relative;
        }
        
        .coordinates-display {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.85rem;
            border-left: 3px solid var(--tde-color);
        }
        
        .coordinates-display div {
            display: flex;
            flex-direction: column;
        }
        
        .coordinates-value {
            font-weight: bold;
            color: var(--ceet-color);
        }
        
        .map-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }
        
        .consumption-unit {
            margin-left: 5px;
            font-weight: normal;
            color: #6c757d;
        }
        
        .records-container {
            background: white;
            padding: 20px 15px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            margin-top: 15px;
        }
        
        .records-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--medium-gray);
        }
        
        .records-list {
            display: grid;
            gap: 12px;
        }
        
        .record-item {
            background: var(--light-gray);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .record-item.ceet {
            border-left-color: var(--ceet-color);
        }
        
        .record-item.tde {
            border-left-color: var(--tde-color);
        }
        
        .record-item:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .record-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .record-title {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .record-service {
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            width: fit-content;
        }
        
        .record-service.ceet {
            background: var(--ceet-color);
        }
        
        .record-service.tde {
            background: var(--tde-color);
        }
        
        .record-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .record-field {
            display: flex;
            flex-direction: column;
        }
        
        .record-label {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 2px;
        }
        
        .record-value {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .record-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        
        .btn-sm {
            padding: 6px 10px;
            font-size: 0.75rem;
        }
        
        .map-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 10px;
        }
        
        .map-modal-content {
            background: white;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .map-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--medium-gray);
        }
        
        .modal-map-container {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            flex: 1;
        }
        
        .route-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        
        .route-info {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            border-left: 4px solid var(--warning);
            font-size: 0.85rem;
        }
        
        .route-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .route-stat {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .route-stat-value {
            font-size: 1rem;
            font-weight: bold;
            color: var(--ceet-color);
        }
        
        .route-stat-label {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .agent-selector {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--ceet-color);
            font-size: 0.85rem;
        }
        
        .filters-container {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--tde-color);
        }
        
        .summary-container {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--warning);
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px;
        }
        
        .summary-stat {
            background: white;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .summary-stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--ceet-color);
            margin-bottom: 4px;
        }
        
        .summary-stat-label {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .agent-interventions {
            margin-top: 15px;
        }
        
        .agent-intervention-item {
            background: var(--light-gray);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid var(--ceet-color);
        }
        
        .route-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 10px;
        }
        
        .route-modal-content {
            background: white;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .route-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--medium-gray);
        }
        
        .route-modal-map {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            flex: 1;
        }
        
        .route-details {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.85rem;
        }
        
        .route-points {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 8px;
        }
        
        .route-point {
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            border-left: 2px solid var(--ceet-color);
            font-size: 0.8rem;
        }
        
        /* Media queries pour les √©crans plus larges */
        @media (min-width: 768px) {
            body {
                padding: 15px;
                font-size: 16px;
            }
            
            .container {
                max-width: 1200px;
                padding: 0 15px;
            }
            
            .auth-card {
                padding: 30px;
                max-width: 500px;
            }
            
            .service-selector {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .btn {
                width: auto;
            }
            
            .btn-group {
                flex-direction: row;
                justify-content: flex-end;
            }
            
            .form-row, .radio-group {
                flex-direction: row;
            }
            
            .form-field {
                min-width: 250px;
            }
            
            .record-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .record-details {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .record-actions {
                flex-direction: row;
            }
            
            .user-info {
                position: absolute;
                top: 15px;
                right: 15px;
                flex-direction: row;
            }
            
            .user-details {
                align-items: flex-end;
            }
            
            .location-examples {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .coordinates-display {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .map-controls, .route-controls {
                flex-direction: row;
            }
            
            .route-stats, .summary-stats {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Media queries pour les tr√®s petits √©crans */
        @media (max-width: 360px) {
            body {
                padding: 5px;
                font-size: 13px;
            }
            
            .auth-card {
                padding: 20px 15px;
            }
            
            .form-container, .records-container {
                padding: 15px 10px;
            }
            
            .map-container, .modal-map-container, .route-modal-map {
                height: 250px;
            }
            
            .btn {
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <!-- √âcran d'authentification -->
    <div id="auth-screen" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h1 class="auth-title">Authentification</h1>
                <p class="auth-subtitle">CEET/TDE Togo - Acc√®s s√©curis√©</p>
            </div>

            <!-- S√©lection du service -->
            <div class="service-selector" id="service-selector">
                <div class="service-option ceet" onclick="selectService('CEET')">
                    <div class="service-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="service-name">CEET</div>
                    <div class="service-desc">Service √âlectricit√©</div>
                </div>
                <div class="service-option tde" onclick="selectService('TDE')">
                    <div class="service-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="service-name">TDE</div>
                    <div class="service-desc">Service Eau</div>
                </div>
            </div>

            <!-- Formulaire d'authentification -->
            <form id="auth-form">
                <div class="form-group">
                    <label for="auth-region">R√©gion</label>
                    <select id="auth-region" class="form-control" required onchange="updateAgencies()">
                        <option value="">S√©lectionnez votre r√©gion</option>
                        <option value="Maritime">R√©gion Maritime</option>
                        <option value="Plateaux">R√©gion des Plateaux</option>
                        <option value="Centrale">R√©gion Centrale</option>
                        <option value="Kara">R√©gion de la Kara</option>
                        <option value="Savanes">R√©gion des Savanes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="auth-agency">Agence</label>
                    <select id="auth-agency" class="form-control" required onchange="updateAgencyAccounts()">
                        <option value="">S√©lectionnez votre agence</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="auth-account">Compte d'Agence</label>
                    <select id="auth-account" class="form-control" required onchange="autoFillAgentInfo()">
                        <option value="">S√©lectionnez votre compte</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="auth-agent-id">Matricule Agent</label>
                    <input type="text" id="auth-agent-id" class="form-control" placeholder="Votre matricule" required readonly>
                </div>

                <div class="form-group">
                    <label for="auth-agent-name">Nom et Pr√©noms</label>
                    <input type="text" id="auth-agent-name" class="form-control" placeholder="Votre nom complet" required readonly>
                </div>

                <div class="form-group">
                    <label for="auth-password">Mot de passe</label>
                    <input type="password" id="auth-password" class="form-control" placeholder="Votre mot de passe" required>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Se connecter
                </button>

                <div class="error-message" id="auth-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="error-text">Identifiants incorrects</span>
                </div>
            </form>
        </div>
    </div>

    <!-- Application principale (cach√©e par d√©faut) -->
    <div id="main-app" class="hidden">
        <div class="container">
            <header>
                <div class="logo-container">
                    <div class="header-logo ceet-header-logo">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <h1>Formulaire d'Intervention</h1>
                    <div class="header-logo tde-header-logo">
                        <i class="fas fa-tint"></i>
                    </div>
                </div>
                <div class="subtitle" id="app-subtitle">CEET/TDE Togo - Enregistrement automatique des interventions</div>
                
                <div class="user-info">
                    <div class="user-details">
                        <div class="user-name" id="current-user-name">Agent</div>
                        <div class="user-role" id="current-user-role">Service - Agence - R√©gion</div>
                        <div class="user-account" id="current-user-account">Compte: --</div>
                    </div>
                    <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-top: 8px;">
                        <i class="fas fa-sign-out-alt"></i> D√©connexion
                    </button>
                </div>
            </header>

            <!-- Formulaire d'intervention -->
            <div class="form-container">
                <div class="form-header">
                    <i class="fas fa-clipboard-list"></i>
                    <div class="form-title">Nouvelle Intervention</div>
                </div>

                <form id="intervention-form">
                    <!-- Section Informations de Base -->
                    <div class="form-section">
                        <div class="section-header">
                            <i class="fas fa-info-circle"></i>
                            <div class="section-title">Informations de Base</div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="service-type" class="required">Type de Service</label>
                                <select id="service-type" required disabled>
                                    <option value="" id="service-type-placeholder">Chargement...</option>
                                </select>
                            </div>
                            
                            <div class="form-field">
                                <label for="agency-account" class="required">Compte d'Agence</label>
                                <select id="agency-account" required disabled>
                                    <option value="" id="agency-account-placeholder">Chargement...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="intervention-type" class="required">Type d'Intervention</label>
                                <select id="intervention-type" required>
                                    <option value="">S√©lectionner le type</option>
                                    <option value="maintenance">Maintenance pr√©ventive</option>
                                    <option value="reparation">R√©paration</option>
                                    <option value="installation">Installation</option>
                                    <option value="controle">Contr√¥le technique</option>
                                    <option value="releve">Relev√© de compteur</option>
                                    <option value="urgence">Intervention d'urgence</option>
                                </select>
                            </div>
                            
                            <div class="form-field">
                                <label for="agent-id" class="required">Matricule Agent</label>
                                <input type="text" id="agent-id" placeholder="Matricule de l'agent" required disabled>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="agent-fullname" class="required">Nom et Pr√©noms Agent</label>
                                <input type="text" id="agent-fullname" placeholder="Nom complet de l'agent" required disabled>
                            </div>
                            
                            <div class="form-field">
                                <label for="client-name" class="required">Nom du Client</label>
                                <input type="text" id="client-name" placeholder="Nom complet du client" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-field">
                                <label for="client-phone">T√©l√©phone Client</label>
                                <input type="text" id="client-phone" placeholder="Num√©ro de t√©l√©phone">
                            </div>
                            
                            <div class="form-field">
                                <label for="client-address" class="required">Adresse du Client</label>
                                <input type="text" id="client-address" placeholder="Adresse compl√®te" required>
                            </div>
                        </div>
                    </div>

                    <!-- Section Localisation -->
                    <div class="form-section">
                        <div class="section-header">
                            <i class="fas fa-map-marker-alt"></i>
                            <div class="section-title">Localisation</div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="region" class="required">R√©gion</label>
                                <select id="region" required disabled>
                                    <option value="" id="region-placeholder">Chargement...</option>
                                </select>
                            </div>
                            
                            <div class="form-field">
                                <label for="ville" class="required">Ville/Commune</label>
                                <input type="text" id="ville" placeholder="Nom de la ville" required>
                            </div>
                        </div>
                        
                        <div class="location-help">
                            <h4><i class="fas fa-info-circle"></i> Coordonn√©es GPS</h4>
                            <p>S√©lectionnez une localisation ou entrez manuellement les coordonn√©es :</p>
                            <div class="location-examples">
                                <div class="location-example" onclick="setExampleCoordinates(6.1304, 1.2158)">
                                    <strong>Lom√© Centre</strong><br>
                                    Lat: 6.1304<br>
                                    Lng: 1.2158
                                </div>
                                <div class="location-example" onclick="setExampleCoordinates(7.5250, 1.1250)">
                                    <strong>Atakpam√©</strong><br>
                                    Lat: 7.5250<br>
                                    Lng: 1.1250
                                </div>
                                <div class="location-example" onclick="setExampleCoordinates(6.9100, 0.6300)">
                                    <strong>Kpalim√©</strong><br>
                                    Lat: 6.9100<br>
                                    Lng: 0.6300
                                </div>
                                <div class="location-example" onclick="setExampleCoordinates(8.9833, 1.1333)">
                                    <strong>Sokod√©</strong><br>
                                    Lat: 8.9833<br>
                                    Lng: 1.1333
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="latitude" class="required">Latitude</label>
                                <input type="number" id="latitude" step="any" placeholder="Ex: 6.1304" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="longitude" class="required">Longitude</label>
                                <input type="number" id="longitude" step="any" placeholder="Ex: 1.2158" required>
                            </div>
                        </div>
                        
                        <div class="coordinates-display" id="coordinates-display">
                            <div>
                                <span>Latitude: </span>
                                <span class="coordinates-value" id="display-lat">--</span>
                            </div>
                            <div>
                                <span>Longitude: </span>
                                <span class="coordinates-value" id="display-lng">--</span>
                            </div>
                            <button type="button" class="btn btn-outline btn-sm" onclick="showOnMap()">
                                <i class="fas fa-map"></i> Voir sur carte
                            </button>
                        </div>
                        
                        <div class="map-controls">
                            <button type="button" class="btn btn-secondary" onclick="getCurrentLocation()">
                                <i class="fas fa-location-arrow"></i> Utiliser ma position actuelle
                            </button>
                            <button type="button" class="btn btn-outline" onclick="openMapPicker()">
                                <i class="fas fa-map-marker-alt"></i> S√©lectionner sur la carte
                            </button>
                        </div>
                        
                        <div class="map-container" id="map-preview">
                            <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #6c757d;">
                                <div style="text-align: center;">
                                    <i class="fas fa-map" style="font-size: 2.5rem; margin-bottom: 8px;"></i>
                                    <p>Carte de pr√©visualisation</p>
                                    <p>Les coordonn√©es GPS s'afficheront ici</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section D√©tails de l'Intervention -->
                    <div class="form-section">
                        <div class="section-header">
                            <i class="fas fa-tools"></i>
                            <div class="section-title">D√©tails de l'Intervention</div>
                        </div>
                        
                        <div class="form-field">
                            <label for="problem-description" class="required">Description du Probl√®me</label>
                            <textarea id="problem-description" placeholder="D√©crivez en d√©tail le probl√®me rencontr√©..." required></textarea>
                        </div>
                        
                        <div class="form-field">
                            <label for="actions-taken" class="required">Actions R√©alis√©es</label>
                            <textarea id="actions-taken" placeholder="D√©crivez les actions que vous avez effectu√©es..." required></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="material-used">Mat√©riel Utilis√©</label>
                                <textarea id="material-used" placeholder="Listez le mat√©riel utilis√©..."></textarea>
                            </div>
                            
                            <div class="form-field">
                                <label for="observation">Observations</label>
                                <textarea id="observation" placeholder="Observations suppl√©mentaires..."></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="intervention-date" class="required">Date d'Intervention</label>
                                <input type="date" id="intervention-date" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="intervention-time" class="required">Heure d'Intervention</label>
                                <input type="time" id="intervention-time" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="intervention-status" class="required">Statut</label>
                                <select id="intervention-status" required>
                                    <option value="completed">Termin√©e</option>
                                    <option value="in_progress">En cours</option>
                                    <option value="scheduled">Planifi√©e</option>
                                    <option value="cancelled">Annul√©e</option>
                                </select>
                            </div>
                            
                            <div class="form-field">
                                <label for="priority-level" class="required">Niveau de Priorit√©</label>
                                <select id="priority-level" required>
                                    <option value="low">Faible</option>
                                    <option value="medium" selected>Moyenne</option>
                                    <option value="high">√âlev√©e</option>
                                    <option value="urgent">Urgente</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Section pour CEET (√âlectricit√©) -->
                    <div class="form-section" id="ceet-section">
                        <div class="section-header">
                            <i class="fas fa-bolt"></i>
                            <div class="section-title">D√©tails √âlectriques (CEET)</div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="compteur-number">Num√©ro de Compteur</label>
                                <input type="text" id="compteur-number" placeholder="Num√©ro du compteur">
                            </div>
                            
                            <div class="form-field">
                                <label for="tension-mesure">Tension Mesur√©e (V)</label>
                                <input type="number" id="tension-mesure" placeholder="Tension en volts">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="intensite-mesure">Intensit√© Mesur√©e (A)</label>
                                <input type="number" id="intensite-mesure" placeholder="Intensit√© en amp√®res">
                            </div>
                            
                            <div class="form-field">
                                <label for="puissance-mesure">Puissance Mesur√©e (kW)</label>
                                <input type="number" id="puissance-mesure" placeholder="Puissance en kW">
                            </div>
                        </div>
                        
                        <div class="form-field">
                            <label>Type d'Installation</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="install-domestique" name="installation-type" value="domestique">
                                    <label for="install-domestique">Domestique</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="install-commercial" name="installation-type" value="commercial">
                                    <label for="install-commercial">Commercial</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="install-industriel" name="installation-type" value="industriel">
                                    <label for="install-industriel">Industriel</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section pour TDE (Eau) -->
                    <div class="form-section" id="tde-section">
                        <div class="section-header">
                            <i class="fas fa-tint"></i>
                            <div class="section-title">D√©tails Eau (TDE)</div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="compteur-eau-number">Num√©ro de Compteur d'Eau</label>
                                <input type="text" id="compteur-eau-number" placeholder="Num√©ro du compteur d'eau">
                            </div>
                            
                            <div class="form-field">
                                <label for="pression-mesure">Pression Mesur√©e (bar)</label>
                                <input type="number" id="pression-mesure" placeholder="Pression en bars">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="debit-mesure">D√©bit Mesur√© (m¬≥/h)</label>
                                <input type="number" id="debit-mesure" placeholder="D√©bit en m¬≥/h">
                            </div>
                            
                            <div class="form-field">
                                <label for="qualite-eau">Qualit√© de l'Eau</label>
                                <select id="qualite-eau">
                                    <option value="">S√©lectionner</option>
                                    <option value="excellente">Excellente</option>
                                    <option value="bonne">Bonne</option>
                                    <option value="moyenne">Moyenne</option>
                                    <option value="mauvaise">Mauvaise</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-field">
                            <label>Type de R√©seau</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="reseau-adduction" name="reseau-type" value="adduction">
                                    <label for="reseau-adduction">Adduction</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="reseau-distribution" name="reseau-type" value="distribution">
                                    <label for="reseau-distribution">Distribution</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="reseau-assainissement" name="reseau-type" value="assainissement">
                                    <label for="reseau-assainissement">Assainissement</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="btn-group">
                        <button type="button" class="btn btn-danger" onclick="resetForm()">
                            <i class="fas fa-trash-alt"></i> Effacer
                        </button>
                        <button type="button" class="btn btn-outline" onclick="saveDraft()">
                            <i class="fas fa-save"></i> Sauvegarder brouillon
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Enregistrer l'intervention
                        </button>
                    </div>

                    <div class="success-message" id="success-message">
                        <i class="fas fa-check-circle"></i>
                        <span id="success-text">Intervention enregistr√©e avec succ√®s!</span>
                    </div>
                </form>
            </div>

            <!-- Section des interventions enregistr√©es -->
            <div class="records-container">
                <div class="records-header">
                    <div class="section-header">
                        <i class="fas fa-history"></i>
                        <div class="section-title">Historique des Interventions</div>
                    </div>
                    <button class="btn btn-outline" onclick="refreshRecords()">
                        <i class="fas fa-sync-alt"></i> Actualiser
                    </button>
                </div>

                <div class="filters-container">
                    <div class="form-row">
                        <div class="form-field">
                            <label for="filter-service">Filtrer par service</label>
                            <select id="filter-service">
                                <option value="all">Tous les services</option>
                                <option value="CEET">CEET</option>
                                <option value="TDE">TDE</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="filter-account">Filtrer par compte</label>
                            <select id="filter-account">
                                <option value="all">Tous les comptes</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="filter-date">Filtrer par date</label>
                            <input type="date" id="filter-date">
                        </div>
                        <div class="form-field">
                            <label for="filter-status">Filtrer par statut</label>
                            <select id="filter-status">
                                <option value="all">Tous les statuts</option>
                                <option value="completed">Termin√©e</option>
                                <option value="in_progress">En cours</option>
                                <option value="scheduled">Planifi√©e</option>
                                <option value="cancelled">Annul√©e</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="summary-container">
                    <h4><i class="fas fa-chart-bar"></i> R√©sum√© des Interventions</h4>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="total-interventions">0</div>
                            <div class="summary-stat-label">Total Interventions</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="ceet-interventions">0</div>
                            <div class="summary-stat-label">Interventions CEET</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="tde-interventions">0</div>
                            <div class="summary-stat-label">Interventions TDE</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="completed-interventions">0</div>
                            <div class="summary-stat-label">Termin√©es</div>
                        </div>
                    </div>
                </div>

                <div class="records-list" id="records-list">
                    <!-- Les interventions seront charg√©es ici dynamiquement -->
                    <div style="text-align: center; padding: 30px; color: #6c757d;">
                        <i class="fas fa-inbox" style="font-size: 2.5rem; margin-bottom: 12px;"></i>
                        <p>Aucune intervention enregistr√©e</p>
                        <p>Les interventions appara√Ætront ici apr√®s enregistrement</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour la carte de localisation -->
    <div class="map-modal" id="map-modal">
        <div class="map-modal-content">
            <div class="map-modal-header">
                <h3><i class="fas fa-map-marker-alt"></i> S√©lectionner la localisation</h3>
                <button class="btn btn-danger" onclick="closeMapModal()">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
            <div class="modal-map-container" id="modal-map"></div>
            <div class="coordinates-display">
                <div>
                    <span>Latitude s√©lectionn√©e: </span>
                    <span class="coordinates-value" id="modal-lat">--</span>
                </div>
                <div>
                    <span>Longitude s√©lectionn√©e: </span>
                    <span class="coordinates-value" id="modal-lng">--</span>
                </div>
                <button class="btn btn-primary" onclick="confirmLocation()">
                    <i class="fas fa-check"></i> Confirmer cette position
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pour l'affichage des itin√©raires -->
    <div class="route-modal" id="route-modal">
        <div class="route-modal-content">
            <div class="route-modal-header">
                <h3><i class="fas fa-route"></i> Itin√©raire vers l'intervention</h3>
                <button class="btn btn-danger" onclick="closeRouteModal()">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
            <div class="agent-selector">
                <label for="route-agent">S√©lectionner un agent pour calculer l'itin√©raire:</label>
                <select id="route-agent" onchange="calculateRoute()">
                    <option value="">Choisir un agent</option>
                </select>
            </div>
            <div class="route-modal-map" id="route-map"></div>
            <div class="route-details">
                <h4><i class="fas fa-info-circle"></i> D√©tails de l'itin√©raire</h4>
                <div class="route-info" id="route-info">
                    <p>S√©lectionnez un agent pour calculer l'itin√©raire</p>
                </div>
                <div class="route-stats" id="route-stats">
                    <!-- Les statistiques d'itin√©raire seront affich√©es ici -->
                </div>
                <div class="route-points" id="route-points">
                    <!-- Les points d'itin√©raire seront affich√©s ici -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentService = '';
        let currentUser = null;
        let map = null;
        let modalMap = null;
        let routeMap = null;
        let currentMarker = null;
        let modalMarker = null;
        let routingControl = null;
        let interventions = JSON.parse(localStorage.getItem('interventions')) || [];
        let drafts = JSON.parse(localStorage.getItem('drafts')) || [];
        let currentRouteIntervention = null;

        // Donn√©es des agences par r√©gion
        const agenciesByRegion = {
            'Maritime': ['Lom√© Centre', 'Lom√© B√®', 'Lom√© Tokoin', 'An√©ho', 'Vogan', 'Tabligbo', 'Ts√©vi√©'],
            'Plateaux': ['Atakpam√©', 'Kpalim√©', 'Badou', 'Amlam√©', 'Nots√®', 'Sotouboua'],
            'Centrale': ['Sokod√©', 'Tchamba', 'S√©r√©gb√©n√©', 'Bafilo'],
            'Kara': ['Kara', 'Bassar', 'Niamtougou', 'Kand√©'],
            'Savanes': ['Dapaong', 'Mango', 'Cinkass√©', 'Tandjouar√©']
        };

        // Donn√©es des comptes d'agences CEET
        const ceetAgencyAccounts = {
            'Lom√© Centre': [
                { 
                    account: 'Compte Principal Lom√© CEET', 
                    matricule: 'CEET-LC-001', 
                    nom: 'Koffi Mensah',
                    password: 'ceet123'
                },
                { 
                    account: 'Compte Commercial Lom√© CEET', 
                    matricule: 'CEET-LC-002', 
                    nom: 'Ama Djibril',
                    password: 'commercial456'
                },
                { 
                    account: 'Compte Industriel Lom√© CEET', 
                    matricule: 'CEET-LC-003', 
                    nom: 'Komlan Adjo',
                    password: 'industriel789'
                }
            ],
            'Lom√© B√®': [
                { 
                    account: 'Compte Principal B√® CEET', 
                    matricule: 'CEET-LB-001', 
                    nom: 'Yaovi Tchalla',
                    password: 'be123'
                },
                { 
                    account: 'Compte R√©sidentiel B√® CEET', 
                    matricule: 'CEET-LB-002', 
                    nom: 'Afia Kouassi',
                    password: 'residentiel456'
                }
            ],
            'Lom√© Tokoin': [
                { 
                    account: 'Compte Principal Tokoin CEET', 
                    matricule: 'CEET-LT-001', 
                    nom: 'Kossi Gbekon',
                    password: 'tokoin123'
                },
                { 
                    account: 'Compte Administratif Tokoin CEET', 
                    matricule: 'CEET-LT-002', 
                    nom: 'Mawuli Agbo',
                    password: 'admin456'
                }
            ],
            'An√©ho': [
                { 
                    account: 'Compte Principal An√©ho CEET', 
                    matricule: 'CEET-AN-001', 
                    nom: 'Komi S√©lom',
                    password: 'aneho123'
                }
            ],
            'Vogan': [
                { 
                    account: 'Compte Principal Vogan CEET', 
                    matricule: 'CEET-VG-001', 
                    nom: 'Kokou Dovi',
                    password: 'vogan123'
                }
            ],
            'Tabligbo': [
                { 
                    account: 'Compte Principal Tabligbo CEET', 
                    matricule: 'CEET-TB-001', 
                    nom: 'Kodjo Mensah',
                    password: 'tabligbo123'
                }
            ],
            'Ts√©vi√©': [
                { 
                    account: 'Compte Principal Ts√©vi√© CEET', 
                    matricule: 'CEET-TS-001', 
                    nom: 'Koffi Adjo',
                    password: 'tsevie123'
                }
            ],
            'Atakpam√©': [
                { 
                    account: 'Compte Principal Atakpam√© CEET', 
                    matricule: 'CEET-AT-001', 
                    nom: 'Kossi Gado',
                    password: 'atakpame123'
                },
                { 
                    account: 'Compte Industriel Atakpam√© CEET', 
                    matricule: 'CEET-AT-002', 
                    nom: 'Mawussi Koffi',
                    password: 'industrie456'
                }
            ],
            'Kpalim√©': [
                { 
                    account: 'Compte Principal Kpalim√© CEET', 
                    matricule: 'CEET-KP-001', 
                    nom: 'Komlan Agb√©',
                    password: 'kpaline123'
                },
                { 
                    account: 'Compte Agricole Kpalim√© CEET', 
                    matricule: 'CEET-KP-002', 
                    nom: 'Koffi Adjoa',
                    password: 'agricole456'
                }
            ],
            'Badou': [
                { 
                    account: 'Compte Principal Badou CEET', 
                    matricule: 'CEET-BD-001', 
                    nom: 'Yaovi Mensah',
                    password: 'badou123'
                }
            ],
            'Amlam√©': [
                { 
                    account: 'Compte Principal Amlam√© CEET', 
                    matricule: 'CEET-AM-001', 
                    nom: 'Kossi Gafan',
                    password: 'amlam√©123'
                }
            ],
            'Nots√®': [
                { 
                    account: 'Compte Principal Nots√® CEET', 
                    matricule: 'CEET-NT-001', 
                    nom: 'Komla Dovi',
                    password: 'notse123'
                }
            ],
            'Sotouboua': [
                { 
                    account: 'Compte Principal Sotouboua CEET', 
                    matricule: 'CEET-ST-001', 
                    nom: 'Koffi Mawuli',
                    password: 'sotouboua123'
                }
            ],
            'Sokod√©': [
                { 
                    account: 'Compte Principal Sokod√© CEET', 
                    matricule: 'CEET-SK-001', 
                    nom: 'Komi Gado',
                    password: 'sokode123'
                },
                { 
                    account: 'Compte Commercial Sokod√© CEET', 
                    matricule: 'CEET-SK-002', 
                    nom: 'Mawuli Kossi',
                    password: 'commercial456'
                }
            ],
            'Tchamba': [
                { 
                    account: 'Compte Principal Tchamba CEET', 
                    matricule: 'CEET-TC-001', 
                    nom: 'Koffi Adjo',
                    password: 'tchamba123'
                }
            ],
            'S√©r√©gb√©n√©': [
                { 
                    account: 'Compte Principal S√©r√©gb√©n√© CEET', 
                    matricule: 'CEET-SG-001', 
                    nom: 'Komlan Mensah',
                    password: 'seregben√©123'
                }
            ],
            'Bafilo': [
                { 
                    account: 'Compte Principal Bafilo CEET', 
                    matricule: 'CEET-BF-001', 
                    nom: 'Yaovi Koffi',
                    password: 'bafilo123'
                }
            ],
            'Kara': [
                { 
                    account: 'Compte Principal Kara CEET', 
                    matricule: 'CEET-KR-001', 
                    nom: 'Kossi Gbekon',
                    password: 'kara123'
                },
                { 
                    account: 'Compte Industriel Kara CEET', 
                    matricule: 'CEET-KR-002', 
                    nom: 'Mawuli Adjo',
                    password: 'industrie456'
                }
            ],
            'Bassar': [
                { 
                    account: 'Compte Principal Bassar CEET', 
                    matricule: 'CEET-BS-001', 
                    nom: 'Komla Gado',
                    password: 'bassar123'
                }
            ],
            'Niamtougou': [
                { 
                    account: 'Compte Principal Niamtougou CEET', 
                    matricule: 'CEET-NG-001', 
                    nom: 'Koffi Mensah',
                    password: 'niamtougou123'
                }
            ],
            'Kand√©': [
                { 
                    account: 'Compte Principal Kand√© CEET', 
                    matricule: 'CEET-KD-001', 
                    nom: 'Yaovi Kossi',
                    password: 'kande123'
                }
            ],
            'Dapaong': [
                { 
                    account: 'Compte Principal Dapaong CEET', 
                    matricule: 'CEET-DP-001', 
                    nom: 'Komlan Gafan',
                    password: 'dapaong123'
                }
            ],
            'Mango': [
                { 
                    account: 'Compte Principal Mango CEET', 
                    matricule: 'CEET-MG-001', 
                    nom: 'Koffi Dovi',
                    password: 'mango123'
                }
            ],
            'Cinkass√©': [
                { 
                    account: 'Compte Principal Cinkass√© CEET', 
                    matricule: 'CEET-CK-001', 
                    nom: 'Mawuli Mensah',
                    password: 'cinkasse123'
                }
            ],
            'Tandjouar√©': [
                { 
                    account: 'Compte Principal Tandjouar√© CEET', 
                    matricule: 'CEET-TJ-001', 
                    nom: 'Kossi Adjo',
                    password: 'tandjouare123'
                }
            ]
        };

        // Donn√©es des comptes d'agences TDE
        const tdeAgencyAccounts = {
            'Lom√© Centre': [
                { 
                    account: 'Compte Principal Lom√© TDE', 
                    matricule: 'TDE-LC-001', 
                    nom: 'Mawuli Adjo',
                    password: 'tde123'
                },
                { 
                    account: 'Compte Commercial Lom√© TDE', 
                    matricule: 'TDE-LC-002', 
                    nom: 'Afia Gado',
                    password: 'commercial456'
                },
                { 
                    account: 'Compte Industriel Lom√© TDE', 
                    matricule: 'TDE-LC-003', 
                    nom: 'Kossi Djibril',
                    password: 'industriel789'
                }
            ],
            'Lom√© B√®': [
                { 
                    account: 'Compte Principal B√® TDE', 
                    matricule: 'TDE-LB-001', 
                    nom: 'Komlan Tchalla',
                    password: 'be123'
                },
                { 
                    account: 'Compte R√©sidentiel B√® TDE', 
                    matricule: 'TDE-LB-002', 
                    nom: 'Yaovi Kouassi',
                    password: 'residentiel456'
                }
            ],
            'Lom√© Tokoin': [
                { 
                    account: 'Compte Principal Tokoin TDE', 
                    matricule: 'TDE-LT-001', 
                    nom: 'Koffi Gbekon',
                    password: 'tokoin123'
                },
                { 
                    account: 'Compte Administratif Tokoin TDE', 
                    matricule: 'TDE-LT-002', 
                    nom: 'Ama Agbo',
                    password: 'admin456'
                }
            ],
            'An√©ho': [
                { 
                    account: 'Compte Principal An√©ho TDE', 
                    matricule: 'TDE-AN-001', 
                    nom: 'Komi Mensah',
                    password: 'aneho123'
                }
            ],
            'Vogan': [
                { 
                    account: 'Compte Principal Vogan TDE', 
                    matricule: 'TDE-VG-001', 
                    nom: 'Kokou Adjo',
                    password: 'vogan123'
                }
            ],
            'Tabligbo': [
                { 
                    account: 'Compte Principal Tabligbo TDE', 
                    matricule: 'TDE-TB-001', 
                    nom: 'Kodjo Gado',
                    password: 'tabligbo123'
                }
            ],
            'Ts√©vi√©': [
                { 
                    account: 'Compte Principal Ts√©vi√© TDE', 
                    matricule: 'TDE-TS-001', 
                    nom: 'Koffi Djibril',
                    password: 'tsevie123'
                }
            ],
            'Atakpam√©': [
                { 
                    account: 'Compte Principal Atakpam√© TDE', 
                    matricule: 'TDE-AT-001', 
                    nom: 'Kossi Adjo',
                    password: 'atakpame123'
                },
                { 
                    account: 'Compte Industriel Atakpam√© TDE', 
                    matricule: 'TDE-AT-002', 
                    nom: 'Mawussi Gado',
                    password: 'industrie456'
                }
            ],
            'Kpalim√©': [
                { 
                    account: 'Compte Principal Kpalim√© TDE', 
                    matricule: 'TDE-KP-001', 
                    nom: 'Komlan Kouassi',
                    password: 'kpaline123'
                },
                { 
                    account: 'Compte Agricole Kpalim√© TDE', 
                    matricule: 'TDE-KP-002', 
                    nom: 'Koffi Mensah',
                    password: 'agricole456'
                }
            ],
            'Badou': [
                { 
                    account: 'Compte Principal Badou TDE', 
                    matricule: 'TDE-BD-001', 
                    nom: 'Yaovi Agbo',
                    password: 'badou123'
                }
            ],
            'Amlam√©': [
                { 
                    account: 'Compte Principal Amlam√© TDE', 
                    matricule: 'TDE-AM-001', 
                    nom: 'Kossi Tchalla',
                    password: 'amlam√©123'
                }
            ],
            'Nots√®': [
                { 
                    account: 'Compte Principal Nots√® TDE', 
                    matricule: 'TDE-NT-001', 
                    nom: 'Komla Gbekon',
                    password: 'notse123'
                }
            ],
            'Sotouboua': [
                { 
                    account: 'Compte Principal Sotouboua TDE', 
                    matricule: 'TDE-ST-001', 
                    nom: 'Koffi Adjoa',
                    password: 'sotouboua123'
                }
            ],
            'Sokod√©': [
                { 
                    account: 'Compte Principal Sokod√© TDE', 
                    matricule: 'TDE-SK-001', 
                    nom: 'Komi Kouassi',
                    password: 'sokode123'
                },
                { 
                    account: 'Compte Commercial Sokod√© TDE', 
                    matricule: 'TDE-SK-002', 
                    nom: 'Mawuli Gado',
                    password: 'commercial456'
                }
            ],
            'Tchamba': [
                { 
                    account: 'Compte Principal Tchamba TDE', 
                    matricule: 'TDE-TC-001', 
                    nom: 'Koffi Mensah',
                    password: 'tchamba123'
                }
            ],
            'S√©r√©gb√©n√©': [
                { 
                    account: 'Compte Principal S√©r√©gb√©n√© TDE', 
                    matricule: 'TDE-SG-001', 
                    nom: 'Komlan Adjo',
                    password: 'seregben√©123'
                }
            ],
            'Bafilo': [
                { 
                    account: 'Compte Principal Bafilo TDE', 
                    matricule: 'TDE-BF-001', 
                    nom: 'Yaovi Gbekon',
                    password: 'bafilo123'
                }
            ],
            'Kara': [
                { 
                    account: 'Compte Principal Kara TDE', 
                    matricule: 'TDE-KR-001', 
                    nom: 'Kossi Agbo',
                    password: 'kara123'
                },
                { 
                    account: 'Compte Industriel Kara TDE', 
                    matricule: 'TDE-KR-002', 
                    nom: 'Mawuli Kouassi',
                    password: 'industrie456'
                }
            ],
            'Bassar': [
                { 
                    account: 'Compte Principal Bassar TDE', 
                    matricule: 'TDE-BS-001', 
                    nom: 'Komla Tchalla',
                    password: 'bassar123'
                }
            ],
            'Niamtougou': [
                { 
                    account: 'Compte Principal Niamtougou TDE', 
                    matricule: 'TDE-NG-001', 
                    nom: 'Koffi Gado',
                    password: 'niamtougou123'
                }
            ],
            'Kand√©': [
                { 
                    account: 'Compte Principal Kand√© TDE', 
                    matricule: 'TDE-KD-001', 
                    nom: 'Yaovi Adjo',
                    password: 'kande123'
                }
            ],
            'Dapaong': [
                { 
                    account: 'Compte Principal Dapaong TDE', 
                    matricule: 'TDE-DP-001', 
                    nom: 'Komlan Kouassi',
                    password: 'dapaong123'
                }
            ],
            'Mango': [
                { 
                    account: 'Compte Principal Mango TDE', 
                    matricule: 'TDE-MG-001', 
                    nom: 'Koffi Gbekon',
                    password: 'mango123'
                }
            ],
            'Cinkass√©': [
                { 
                    account: 'Compte Principal Cinkass√© TDE', 
                    matricule: 'TDE-CK-001', 
                    nom: 'Mawuli Adjo',
                    password: 'cinkasse123'
                }
            ],
            'Tandjouar√©': [
                { 
                    account: 'Compte Principal Tandjouar√© TDE', 
                    matricule: 'TDE-TJ-001', 
                    nom: 'Kossi Mensah',
                    password: 'tandjouare123'
                }
            ]
        };

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', function() {
            // D√©finir la date d'aujourd'hui comme date par d√©faut
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('intervention-date').value = today;
            
            // D√©finir l'heure actuelle comme heure par d√©faut
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('intervention-time').value = `${hours}:${minutes}`;
            
            // Initialiser les √©couteurs d'√©v√©nements
            initializeEventListeners();
            
            // Charger les √©bauches sauvegard√©es
            loadDrafts();
            
            // Mettre √† jour les statistiques
            updateStatistics();
            
            // Mettre √† jour les filtres de compte
            updateAccountFilters();
        });

        // Fonction pour s√©lectionner le service
        function selectService(service) {
            currentService = service;
            const ceetOption = document.querySelector('.service-option.ceet');
            const tdeOption = document.querySelector('.service-option.tde');
            
            if (service === 'CEET') {
                ceetOption.classList.add('selected');
                tdeOption.classList.remove('selected');
            } else {
                tdeOption.classList.add('selected');
                ceetOption.classList.remove('selected');
            }
            
            // Mettre √† jour les agences disponibles
            updateAgencies();
        }

        // Fonction pour mettre √† jour les agences en fonction de la r√©gion
        function updateAgencies() {
            const region = document.getElementById('auth-region').value;
            const agencySelect = document.getElementById('auth-agency');
            
            // Vider les options actuelles
            agencySelect.innerHTML = '<option value="">S√©lectionnez votre agence</option>';
            
            if (region && agenciesByRegion[region]) {
                agenciesByRegion[region].forEach(agency => {
                    const option = document.createElement('option');
                    option.value = agency;
                    option.textContent = agency;
                    agencySelect.appendChild(option);
                });
            }
            
            // R√©initialiser les comptes d'agence
            document.getElementById('auth-account').innerHTML = '<option value="">S√©lectionnez votre compte</option>';
            document.getElementById('auth-agent-id').value = '';
            document.getElementById('auth-agent-name').value = '';
        }

        // Fonction pour mettre √† jour les comptes d'agence
        function updateAgencyAccounts() {
            const agency = document.getElementById('auth-agency').value;
            const accountSelect = document.getElementById('auth-account');
            
            // Vider les options actuelles
            accountSelect.innerHTML = '<option value="">S√©lectionnez votre compte</option>';
            
            let agencyAccountsData = {};
            
            // S√©lectionner les comptes en fonction du service
            if (currentService === 'CEET') {
                agencyAccountsData = ceetAgencyAccounts;
            } else if (currentService === 'TDE') {
                agencyAccountsData = tdeAgencyAccounts;
            }
            
            if (agency && agencyAccountsData[agency]) {
                agencyAccountsData[agency].forEach(accountInfo => {
                    const option = document.createElement('option');
                    option.value = accountInfo.account;
                    option.textContent = accountInfo.account;
                    option.setAttribute('data-matricule', accountInfo.matricule);
                    option.setAttribute('data-nom', accountInfo.nom);
                    option.setAttribute('data-password', accountInfo.password);
                    accountSelect.appendChild(option);
                });
            }
            
            document.getElementById('auth-agent-id').value = '';
            document.getElementById('auth-agent-name').value = '';
        }

        // Fonction pour remplir automatiquement les informations de l'agent
        function autoFillAgentInfo() {
            const accountSelect = document.getElementById('auth-account');
            const selectedOption = accountSelect.options[accountSelect.selectedIndex];
            
            if (selectedOption.value) {
                const matricule = selectedOption.getAttribute('data-matricule');
                const nom = selectedOption.getAttribute('data-nom');
                
                document.getElementById('auth-agent-id').value = matricule || '';
                document.getElementById('auth-agent-name').value = nom || '';
            } else {
                document.getElementById('auth-agent-id').value = '';
                document.getElementById('auth-agent-name').value = '';
            }
        }

        // Fonction pour g√©rer l'authentification
        document.getElementById('auth-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const region = document.getElementById('auth-region').value;
            const agency = document.getElementById('auth-agency').value;
            const account = document.getElementById('auth-account').value;
            const agentId = document.getElementById('auth-agent-id').value;
            const agentName = document.getElementById('auth-agent-name').value;
            const password = document.getElementById('auth-password').value;
            
            // Validation basique
            if (!region || !agency || !account || !agentId || !agentName || !password) {
                showAuthError('Veuillez remplir tous les champs');
                return;
            }
            
            if (!currentService) {
                showAuthError('Veuillez s√©lectionner un service');
                return;
            }
            
            // V√©rification du mot de passe
            const accountSelect = document.getElementById('auth-account');
            const selectedOption = accountSelect.options[accountSelect.selectedIndex];
            const correctPassword = selectedOption.getAttribute('data-password');
            
            if (password !== correctPassword) {
                showAuthError('Mot de passe incorrect');
                return;
            }
            
            // Authentification r√©ussie
            currentUser = {
                service: currentService,
                region: region,
                agency: agency,
                account: account,
                agentId: agentId,
                agentName: agentName
            };
            
            // Basculer vers l'application principale
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Mettre √† jour l'interface utilisateur
            updateUserInterface();
        });

        // Fonction pour afficher les erreurs d'authentification
        function showAuthError(message) {
            const errorElement = document.getElementById('auth-error');
            document.getElementById('error-text').textContent = message;
            errorElement.style.display = 'block';
            
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Fonction pour mettre √† jour l'interface utilisateur apr√®s connexion
        function updateUserInterface() {
            // Mettre √† jour les informations utilisateur
            document.getElementById('current-user-name').textContent = currentUser.agentName;
            document.getElementById('current-user-role').textContent = 
                `${currentUser.service} - ${currentUser.agency} - ${currentUser.region}`;
            document.getElementById('current-user-account').textContent = 
                `Compte: ${currentUser.account}`;
            
            // Mettre √† jour le sous-titre de l'application
            document.getElementById('app-subtitle').textContent = 
                `${currentUser.service} Togo - Enregistrement automatique des interventions`;
            
            // Mettre √† jour les champs du formulaire avec les informations de l'utilisateur
            document.getElementById('service-type').innerHTML = 
                `<option value="${currentUser.service}">${currentUser.service}</option>`;
            document.getElementById('agency-account').innerHTML = 
                `<option value="${currentUser.account}">${currentUser.account}</option>`;
            document.getElementById('agent-id').value = currentUser.agentId;
            document.getElementById('agent-fullname').value = currentUser.agentName;
            document.getElementById('region').innerHTML = 
                `<option value="${currentUser.region}">${currentUser.region}</option>`;
            
            // Afficher/masquer les sections sp√©cifiques au service
            if (currentUser.service === 'CEET') {
                document.getElementById('ceet-section').style.display = 'block';
                document.getElementById('tde-section').style.display = 'none';
            } else {
                document.getElementById('ceet-section').style.display = 'none';
                document.getElementById('tde-section').style.display = 'block';
            }
            
            // Initialiser la carte de pr√©visualisation
            initializePreviewMap();
            
            // Mettre √† jour les filtres de compte
            updateAccountFilters();
        }

        // Fonction pour initialiser la carte de pr√©visualisation
        function initializePreviewMap() {
            const mapElement = document.getElementById('map-preview');
            
            // Vider la carte
            mapElement.innerHTML = '';
            
            // Initialiser la carte Leaflet centr√©e sur le Togo
            map = L.map('map-preview').setView([8.6195, 0.8248], 8);
            
            // Ajouter la couche de tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Ajouter un marqueur par d√©faut
            currentMarker = L.marker([8.6195, 0.8248]).addTo(map)
                .bindPopup('Position par d√©faut')
                .openPopup();
        }

        // Fonction pour d√©finir des coordonn√©es d'exemple
        function setExampleCoordinates(lat, lng) {
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            updateCoordinatesDisplay();
            updateMapMarker(lat, lng);
        }

        // Fonction pour mettre √† jour l'affichage des coordonn√©es
        function updateCoordinatesDisplay() {
            const lat = document.getElementById('latitude').value;
            const lng = document.getElementById('longitude').value;
            
            document.getElementById('display-lat').textContent = lat || '--';
            document.getElementById('display-lng').textContent = lng || '--';
        }

        // Fonction pour mettre √† jour le marqueur sur la carte
        function updateMapMarker(lat, lng) {
            if (map && currentMarker) {
                map.setView([lat, lng], 13);
                currentMarker.setLatLng([lat, lng])
                    .bindPopup(`Position s√©lectionn√©e: ${lat}, ${lng}`)
                    .openPopup();
            }
        }

        // Fonction pour obtenir la position actuelle
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lng;
                        updateCoordinatesDisplay();
                        updateMapMarker(lat, lng);
                        
                        // Afficher un message de succ√®s
                        showSuccessMessage('Position actuelle r√©cup√©r√©e avec succ√®s!');
                    },
                    function(error) {
                        let errorMessage = 'Erreur lors de la r√©cup√©ration de la position: ';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'Permission refus√©e.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'Position indisponible.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'Timeout.';
                                break;
                            default:
                                errorMessage += 'Erreur inconnue.';
                                break;
                        }
                        
                        alert(errorMessage);
                    }
                );
            } else {
                alert('La g√©olocalisation n\'est pas support√©e par ce navigateur.');
            }
        }

        // Fonction pour ouvrir le s√©lecteur de carte
        function openMapPicker() {
            const modal = document.getElementById('map-modal');
            modal.style.display = 'flex';
            
            // Initialiser la carte modale si ce n'est pas d√©j√† fait
            if (!modalMap) {
                initializeModalMap();
            }
        }

        // Fonction pour initialiser la carte modale
        function initializeModalMap() {
            const modalMapElement = document.getElementById('modal-map');
            
            // Initialiser la carte Leaflet centr√©e sur le Togo
            modalMap = L.map('modal-map').setView([8.6195, 0.8248], 8);
            
            // Ajouter la couche de tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(modalMap);
            
            // Ajouter un marqueur par d√©faut
            modalMarker = L.marker([8.6195, 0.8248]).addTo(modalMap)
                .bindPopup('Cliquez sur la carte pour s√©lectionner une position')
                .openPopup();
            
            // Mettre √† jour les coordonn√©es lorsqu'on clique sur la carte
            modalMap.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                document.getElementById('modal-lat').textContent = lat.toFixed(6);
                document.getElementById('modal-lng').textContent = lng.toFixed(6);
                
                modalMarker.setLatLng([lat, lng])
                    .bindPopup(`Position s√©lectionn√©e: ${lat.toFixed(6)}, ${lng.toFixed(6)}`)
                    .openPopup();
            });
        }

        // Fonction pour fermer le modal de carte
        function closeMapModal() {
            document.getElementById('map-modal').style.display = 'none';
        }

        // Fonction pour confirmer la position s√©lectionn√©e
        function confirmLocation() {
            const lat = document.getElementById('modal-lat').textContent;
            const lng = document.getElementById('modal-lng').textContent;
            
            if (lat !== '--' && lng !== '--') {
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;
                updateCoordinatesDisplay();
                updateMapMarker(parseFloat(lat), parseFloat(lng));
                closeMapModal();
                showSuccessMessage('Position confirm√©e avec succ√®s!');
            } else {
                alert('Veuillez s√©lectionner une position sur la carte.');
            }
        }

        // Fonction pour afficher la position sur la carte
        function showOnMap() {
            const lat = document.getElementById('latitude').value;
            const lng = document.getElementById('longitude').value;
            
            if (lat && lng) {
                openMapPicker();
                
                // Centrer la carte sur les coordonn√©es
                setTimeout(() => {
                    modalMap.setView([parseFloat(lat), parseFloat(lng)], 15);
                    modalMarker.setLatLng([parseFloat(lat), parseFloat(lng)])
                        .bindPopup(`Position actuelle: ${lat}, ${lng}`)
                        .openPopup();
                    
                    document.getElementById('modal-lat').textContent = lat;
                    document.getElementById('modal-lng').textContent = lng;
                }, 500);
            } else {
                alert('Veuillez d\'abord entrer des coordonn√©es GPS.');
            }
        }

        // Fonction pour initialiser les √©couteurs d'√©v√©nements
        function initializeEventListeners() {
            // Mettre √† jour l'affichage des coordonn√©es lorsque les champs changent
            document.getElementById('latitude').addEventListener('input', updateCoordinatesDisplay);
            document.getElementById('longitude').addEventListener('input', updateCoordinatesDisplay);
            
            // G√©rer la soumission du formulaire d'intervention
            document.getElementById('intervention-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveIntervention();
            });
            
            // G√©rer les filtres
            document.getElementById('filter-service').addEventListener('change', filterRecords);
            document.getElementById('filter-account').addEventListener('change', filterRecords);
            document.getElementById('filter-date').addEventListener('change', filterRecords);
            document.getElementById('filter-status').addEventListener('change', filterRecords);
        }

        // Fonction pour enregistrer une intervention
        function saveIntervention() {
            // R√©cup√©rer les donn√©es du formulaire
            const intervention = {
                id: generateId(),
                serviceType: document.getElementById('service-type').value,
                agencyAccount: document.getElementById('agency-account').value,
                interventionType: document.getElementById('intervention-type').value,
                agentId: document.getElementById('agent-id').value,
                agentFullname: document.getElementById('agent-fullname').value,
                clientName: document.getElementById('client-name').value,
                clientPhone: document.getElementById('client-phone').value,
                clientAddress: document.getElementById('client-address').value,
                region: document.getElementById('region').value,
                ville: document.getElementById('ville').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                problemDescription: document.getElementById('problem-description').value,
                actionsTaken: document.getElementById('actions-taken').value,
                materialUsed: document.getElementById('material-used').value,
                observation: document.getElementById('observation').value,
                interventionDate: document.getElementById('intervention-date').value,
                interventionTime: document.getElementById('intervention-time').value,
                interventionStatus: document.getElementById('intervention-status').value,
                priorityLevel: document.getElementById('priority-level').value,
                timestamp: new Date().toISOString()
            };
            
            // Ajouter les donn√©es sp√©cifiques au service
            if (intervention.serviceType === 'CEET') {
                intervention.ceetDetails = {
                    compteurNumber: document.getElementById('compteur-number').value,
                    tensionMesure: document.getElementById('tension-mesure').value,
                    intensiteMesure: document.getElementById('intensite-mesure').value,
                    puissanceMesure: document.getElementById('puissance-mesure').value,
                    installationType: document.querySelector('input[name="installation-type"]:checked')?.value
                };
            } else {
                intervention.tdeDetails = {
                    compteurEauNumber: document.getElementById('compteur-eau-number').value,
                    pressionMesure: document.getElementById('pression-mesure').value,
                    debitMesure: document.getElementById('debit-mesure').value,
                    qualiteEau: document.getElementById('qualite-eau').value,
                    reseauType: document.querySelector('input[name="reseau-type"]:checked')?.value
                };
            }
            
            // Ajouter √† la liste des interventions
            interventions.push(intervention);
            
            // Sauvegarder dans le localStorage
            localStorage.setItem('interventions', JSON.stringify(interventions));
            
            // Afficher un message de succ√®s
            showSuccessMessage('Intervention enregistr√©e avec succ√®s!');
            
            // R√©initialiser le formulaire
            resetForm();
            
            // Actualiser l'affichage des enregistrements
            displayRecords();
            
            // Mettre √† jour les statistiques
            updateStatistics();
        }

        // Fonction pour g√©n√©rer un ID unique
        function generateId() {
            return 'INT_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Fonction pour afficher un message de succ√®s
        function showSuccessMessage(message) {
            const successElement = document.getElementById('success-message');
            document.getElementById('success-text').textContent = message;
            successElement.style.display = 'block';
            
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 5000);
        }

        // Fonction pour r√©initialiser le formulaire
        function resetForm() {
            document.getElementById('intervention-form').reset();
            
            // R√©initialiser les champs sp√©cifiques √† l'utilisateur
            document.getElementById('service-type').innerHTML = 
                `<option value="${currentUser.service}">${currentUser.service}</option>`;
            document.getElementById('agency-account').innerHTML = 
                `<option value="${currentUser.account}">${currentUser.account}</option>`;
            document.getElementById('agent-id').value = currentUser.agentId;
            document.getElementById('agent-fullname').value = currentUser.agentName;
            document.getElementById('region').innerHTML = 
                `<option value="${currentUser.region}">${currentUser.region}</option>`;
            
            // R√©initialiser l'affichage des coordonn√©es
            updateCoordinatesDisplay();
            
            // R√©initialiser la carte
            if (map && currentMarker) {
                map.setView([8.6195, 0.8248], 8);
                currentMarker.setLatLng([8.6195, 0.8248])
                    .bindPopup('Position par d√©faut')
                    .openPopup();
            }
            
            // D√©finir la date et l'heure actuelles
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('intervention-date').value = today;
            
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('intervention-time').value = `${hours}:${minutes}`;
        }

        // Fonction pour sauvegarder un brouillon
        function saveDraft() {
            // R√©cup√©rer les donn√©es du formulaire
            const draft = {
                id: 'DRAFT_' + Date.now(),
                serviceType: document.getElementById('service-type').value,
                agencyAccount: document.getElementById('agency-account').value,
                interventionType: document.getElementById('intervention-type').value,
                agentId: document.getElementById('agent-id').value,
                agentFullname: document.getElementById('agent-fullname').value,
                clientName: document.getElementById('client-name').value,
                clientPhone: document.getElementById('client-phone').value,
                clientAddress: document.getElementById('client-address').value,
                region: document.getElementById('region').value,
                ville: document.getElementById('ville').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                problemDescription: document.getElementById('problem-description').value,
                actionsTaken: document.getElementById('actions-taken').value,
                materialUsed: document.getElementById('material-used').value,
                observation: document.getElementById('observation').value,
                interventionDate: document.getElementById('intervention-date').value,
                interventionTime: document.getElementById('intervention-time').value,
                interventionStatus: document.getElementById('intervention-status').value,
                priorityLevel: document.getElementById('priority-level').value,
                timestamp: new Date().toISOString()
            };
            
            // Ajouter √† la liste des brouillons
            drafts.push(draft);
            
            // Sauvegarder dans le localStorage
            localStorage.setItem('drafts', JSON.stringify(drafts));
            
            // Afficher un message de succ√®s
            showSuccessMessage('Brouillon sauvegard√© avec succ√®s!');
        }

        // Fonction pour charger les brouillons
        function loadDrafts() {
            // Cette fonction pourrait √™tre utilis√©e pour charger et afficher les brouillons
            // Pour l'instant, nous stockons simplement les brouillons
            console.log('Brouillons charg√©s:', drafts.length);
        }

        // Fonction pour afficher les enregistrements
        function displayRecords() {
            const recordsList = document.getElementById('records-list');
            const filteredInterventions = filterInterventions();
            
            if (filteredInterventions.length === 0) {
                recordsList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #6c757d;">
                        <i class="fas fa-inbox" style="font-size: 2.5rem; margin-bottom: 12px;"></i>
                        <p>Aucune intervention correspondant aux crit√®res</p>
                    </div>
                `;
                return;
            }
            
            recordsList.innerHTML = filteredInterventions.map(intervention => `
                <div class="record-item ${intervention.serviceType.toLowerCase()}" onclick="showInterventionDetails('${intervention.id}')">
                    <div class="record-header">
                        <div class="record-title">Intervention #${intervention.id.substring(0, 8)}</div>
                        <div class="record-service ${intervention.serviceType.toLowerCase()}">${intervention.serviceType}</div>
                    </div>
                    <div class="record-details">
                        <div class="record-field">
                            <div class="record-label">Client</div>
                            <div class="record-value">${intervention.clientName}</div>
                        </div>
                        <div class="record-field">
                            <div class="record-label">Compte</div>
                            <div class="record-value">${intervention.agencyAccount}</div>
                        </div>
                        <div class="record-field">
                            <div class="record-label">Date</div>
                            <div class="record-value">${formatDate(intervention.interventionDate)} ${intervention.interventionTime}</div>
                        </div>
                        <div class="record-field">
                            <div class="record-label">Type</div>
                            <div class="record-value">${getInterventionTypeLabel(intervention.interventionType)}</div>
                        </div>
                        <div class="record-field">
                            <div class="record-label">Statut</div>
                            <div class="record-value">${getStatusLabel(intervention.interventionStatus)}</div>
                        </div>
                    </div>
                    <div class="record-actions">
                        <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); showOnMapRoute('${intervention.id}')">
                            <i class="fas fa-route"></i> Itin√©raire
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); editIntervention('${intervention.id}')">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteIntervention('${intervention.id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Fonction pour formater une date
        function formatDate(dateString) {
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('fr-FR', options);
        }

        // Fonction pour obtenir le libell√© du type d'intervention
        function getInterventionTypeLabel(type) {
            const types = {
                'maintenance': 'Maintenance pr√©ventive',
                'reparation': 'R√©paration',
                'installation': 'Installation',
                'controle': 'Contr√¥le technique',
                'releve': 'Relev√© de compteur',
                'urgence': 'Intervention d\'urgence'
            };
            return types[type] || type;
        }

        // Fonction pour obtenir le libell√© du statut
        function getStatusLabel(status) {
            const statuses = {
                'completed': 'Termin√©e',
                'in_progress': 'En cours',
                'scheduled': 'Planifi√©e',
                'cancelled': 'Annul√©e'
            };
            return statuses[status] || status;
        }

        // Fonction pour filtrer les interventions
        function filterInterventions() {
            const serviceFilter = document.getElementById('filter-service').value;
            const accountFilter = document.getElementById('filter-account').value;
            const dateFilter = document.getElementById('filter-date').value;
            const statusFilter = document.getElementById('filter-status').value;
            
            return interventions.filter(intervention => {
                // Filtre par service
                if (serviceFilter !== 'all' && intervention.serviceType !== serviceFilter) {
                    return false;
                }
                
                // Filtre par compte
                if (accountFilter !== 'all' && intervention.agencyAccount !== accountFilter) {
                    return false;
                }
                
                // Filtre par date
                if (dateFilter && intervention.interventionDate !== dateFilter) {
                    return false;
                }
                
                // Filtre par statut
                if (statusFilter !== 'all' && intervention.interventionStatus !== statusFilter) {
                    return false;
                }
                
                return true;
            });
        }

        // Fonction pour appliquer les filtres
        function filterRecords() {
            displayRecords();
            updateStatistics();
        }

        // Fonction pour actualiser les enregistrements
        function refreshRecords() {
            displayRecords();
            updateStatistics();
            showSuccessMessage('Liste actualis√©e avec succ√®s!');
        }

        // Fonction pour mettre √† jour les statistiques
        function updateStatistics() {
            const total = interventions.length;
            const ceetCount = interventions.filter(i => i.serviceType === 'CEET').length;
            const tdeCount = interventions.filter(i => i.serviceType === 'TDE').length;
            const completedCount = interventions.filter(i => i.interventionStatus === 'completed').length;
            
            document.getElementById('total-interventions').textContent = total;
            document.getElementById('ceet-interventions').textContent = ceetCount;
            document.getElementById('tde-interventions').textContent = tdeCount;
            document.getElementById('completed-interventions').textContent = completedCount;
        }

        // Fonction pour mettre √† jour les filtres de compte
        function updateAccountFilters() {
            const accountFilter = document.getElementById('filter-account');
            
            // Vider les options actuelles
            accountFilter.innerHTML = '<option value="all">Tous les comptes</option>';
            
            // R√©cup√©rer tous les comptes uniques
            const uniqueAccounts = [...new Set(interventions.map(i => i.agencyAccount))];
            
            uniqueAccounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account;
                option.textContent = account;
                accountFilter.appendChild(option);
            });
        }

        // Fonction pour afficher les d√©tails d'une intervention
        function showInterventionDetails(interventionId) {
            const intervention = interventions.find(i => i.id === interventionId);
            if (intervention) {
                alert(`D√©tails de l'intervention:\n\nClient: ${intervention.clientName}\nCompte: ${intervention.agencyAccount}\nAdresse: ${intervention.clientAddress}\nType: ${getInterventionTypeLabel(intervention.interventionType)}\nStatut: ${getStatusLabel(intervention.interventionStatus)}\nDescription: ${intervention.problemDescription}`);
            }
        }

        // Fonction pour afficher l'itin√©raire vers une intervention
        function showOnMapRoute(interventionId) {
            const intervention = interventions.find(i => i.id === interventionId);
            if (intervention) {
                // Ouvrir le modal d'itin√©raire
                document.getElementById('route-modal').style.display = 'flex';
                
                // Initialiser la carte d'itin√©raire si ce n'est pas d√©j√† fait
                if (!routeMap) {
                    initializeRouteMap();
                }
                
                // Centrer la carte sur l'intervention
                routeMap.setView([parseFloat(intervention.latitude), parseFloat(intervention.longitude)], 13);
                
                // Ajouter un marqueur pour l'intervention
                L.marker([parseFloat(intervention.latitude), parseFloat(intervention.longitude)])
                    .addTo(routeMap)
                    .bindPopup(`Intervention: ${intervention.clientName}<br>${intervention.clientAddress}`)
                    .openPopup();
                
                // Mettre √† jour la liste des agents
                updateRouteAgents();
                
                // Stocker l'intervention courante pour le calcul d'itin√©raire
                currentRouteIntervention = intervention;
            }
        }

        // Fonction pour initialiser la carte d'itin√©raire
        function initializeRouteMap() {
            const routeMapElement = document.getElementById('route-map');
            
            // Initialiser la carte Leaflet
            routeMap = L.map('route-map').setView([8.6195, 0.8248], 8);
            
            // Ajouter la couche de tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(routeMap);
        }

        // Fonction pour mettre √† jour la liste des agents pour l'itin√©raire
        function updateRouteAgents() {
            const routeAgentSelect = document.getElementById('route-agent');
            routeAgentSelect.innerHTML = '<option value="">Choisir un agent</option>';
            
            // Simuler une liste d'agents (en production, cela viendrait d'une base de donn√©es)
            const agents = [
                { id: 'agent1', name: 'Koffi Mensah', latitude: 6.1304, longitude: 1.2158 },
                { id: 'agent2', name: 'Ama Djibril', latitude: 6.9100, longitude: 0.6300 },
                { id: 'agent3', name: 'Komlan Adjo', latitude: 7.5250, longitude: 1.1250 },
                { id: 'agent4', name: 'Yaovi Tchalla', latitude: 8.9833, longitude: 1.1333 }
            ];
            
            agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = agent.name;
                option.setAttribute('data-lat', agent.latitude);
                option.setAttribute('data-lng', agent.longitude);
                routeAgentSelect.appendChild(option);
            });
        }

        // Fonction pour calculer l'itin√©raire
        function calculateRoute() {
            const routeAgentSelect = document.getElementById('route-agent');
            const selectedAgentId = routeAgentSelect.value;
            
            if (!selectedAgentId || !currentRouteIntervention) {
                return;
            }
            
            const selectedOption = routeAgentSelect.options[routeAgentSelect.selectedIndex];
            const agentLat = parseFloat(selectedOption.getAttribute('data-lat'));
            const agentLng = parseFloat(selectedOption.getAttribute('data-lng'));
            const interventionLat = parseFloat(currentRouteIntervention.latitude);
            const interventionLng = parseFloat(currentRouteIntervention.longitude);
            
            // Nettoyer le contr√¥le d'itin√©raire pr√©c√©dent s'il existe
            if (routingControl) {
                routeMap.removeControl(routingControl);
            }
            
            // Cr√©er le contr√¥le d'itin√©raire
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(agentLat, agentLng),
                    L.latLng(interventionLat, interventionLng)
                ],
                routeWhileDragging: true,
                showAlternatives: true,
                lineOptions: {
                    styles: [{ color: '#1a5276', opacity: 0.7, weight: 5 }]
                },
                createMarker: function(i, waypoint, n) {
                    if (i === 0) {
                        return L.marker(waypoint.latLng).bindPopup('D√©part: Agent');
                    } else {
                        return L.marker(waypoint.latLng).bindPopup('Arriv√©e: Intervention');
                    }
                }
            }).addTo(routeMap);
            
            // Mettre √† jour les informations d'itin√©raire
            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                
                // Mettre √† jour l'affichage des informations
                document.getElementById('route-info').innerHTML = `
                    <p><strong>Itin√©raire calcul√©:</strong> ${selectedOption.textContent} ‚Üí ${currentRouteIntervention.clientName}</p>
                    <p><strong>Distance:</strong> ${(summary.totalDistance / 1000).toFixed(2)} km</p>
                    <p><strong>Dur√©e estim√©e:</strong> ${Math.round(summary.totalTime / 60)} minutes</p>
                `;
                
                // Mettre √† jour les statistiques
                document.getElementById('route-stats').innerHTML = `
                    <div class="route-stat">
                        <div class="route-stat-value">${(summary.totalDistance / 1000).toFixed(2)}</div>
                        <div class="route-stat-label">Distance (km)</div>
                    </div>
                    <div class="route-stat">
                        <div class="route-stat-value">${Math.round(summary.totalTime / 60)}</div>
                        <div class="route-stat-label">Dur√©e (min)</div>
                    </div>
                    <div class="route-stat">
                        <div class="route-stat-value">${routes.length}</div>
                        <div class="route-stat-label">Itin√©raires</div>
                    </div>
                `;
                
                // Afficher les points d'itin√©raire
                const routePoints = document.getElementById('route-points');
                routePoints.innerHTML = '<h5>Points de passage:</h5>';
                
                routes[0].instructions.forEach((instruction, index) => {
                    const pointElement = document.createElement('div');
                    pointElement.className = 'route-point';
                    pointElement.innerHTML = `
                        <strong>√âtape ${index + 1}:</strong> ${instruction.text}
                        <br><small>Distance: ${(instruction.distance / 1000).toFixed(2)} km</small>
                    `;
                    routePoints.appendChild(pointElement);
                });
            });
        }

        // Fonction pour fermer le modal d'itin√©raire
        function closeRouteModal() {
            document.getElementById('route-modal').style.display = 'none';
            
            // Nettoyer le contr√¥le d'itin√©raire
            if (routingControl) {
                routeMap.removeControl(routingControl);
                routingControl = null;
            }
        }

        // Fonction pour modifier une intervention
        function editIntervention(interventionId) {
            const intervention = interventions.find(i => i.id === interventionId);
            if (intervention) {
                // Remplir le formulaire avec les donn√©es de l'intervention
                document.getElementById('service-type').value = intervention.serviceType;
                document.getElementById('agency-account').value = intervention.agencyAccount;
                document.getElementById('intervention-type').value = intervention.interventionType;
                document.getElementById('client-name').value = intervention.clientName;
                document.getElementById('client-phone').value = intervention.clientPhone;
                document.getElementById('client-address').value = intervention.clientAddress;
                document.getElementById('ville').value = intervention.ville;
                document.getElementById('latitude').value = intervention.latitude;
                document.getElementById('longitude').value = intervention.longitude;
                document.getElementById('problem-description').value = intervention.problemDescription;
                document.getElementById('actions-taken').value = intervention.actionsTaken;
                document.getElementById('material-used').value = intervention.materialUsed;
                document.getElementById('observation').value = intervention.observation;
                document.getElementById('intervention-date').value = intervention.interventionDate;
                document.getElementById('intervention-time').value = intervention.interventionTime;
                document.getElementById('intervention-status').value = intervention.interventionStatus;
                document.getElementById('priority-level').value = intervention.priorityLevel;
                
                // Mettre √† jour l'affichage des coordonn√©es et la carte
                updateCoordinatesDisplay();
                updateMapMarker(parseFloat(intervention.latitude), parseFloat(intervention.longitude));
                
                // Remplir les champs sp√©cifiques au service
                if (intervention.serviceType === 'CEET' && intervention.ceetDetails) {
                    document.getElementById('compteur-number').value = intervention.ceetDetails.compteurNumber;
                    document.getElementById('tension-mesure').value = intervention.ceetDetails.tensionMesure;
                    document.getElementById('intensite-mesure').value = intervention.ceetDetails.intensiteMesure;
                    document.getElementById('puissance-mesure').value = intervention.ceetDetails.puissanceMesure;
                    
                    if (intervention.ceetDetails.installationType) {
                        document.getElementById(`install-${intervention.ceetDetails.installationType}`).checked = true;
                    }
                } else if (intervention.serviceType === 'TDE' && intervention.tdeDetails) {
                    document.getElementById('compteur-eau-number').value = intervention.tdeDetails.compteurEauNumber;
                    document.getElementById('pression-mesure').value = intervention.tdeDetails.pressionMesure;
                    document.getElementById('debit-mesure').value = intervention.tdeDetails.debitMesure;
                    document.getElementById('qualite-eau').value = intervention.tdeDetails.qualiteEau;
                    
                    if (intervention.tdeDetails.reseauType) {
                        document.getElementById(`reseau-${intervention.tdeDetails.reseauType}`).checked = true;
                    }
                }
                
                // Supprimer l'intervention de la liste (elle sera recr√©√©e lors de la sauvegarde)
                interventions = interventions.filter(i => i.id !== interventionId);
                localStorage.setItem('interventions', JSON.stringify(interventions));
                
                // Afficher un message
                showSuccessMessage('Intervention charg√©e pour modification. Enregistrez pour sauvegarder les modifications.');
                
                // Faire d√©filer jusqu'au formulaire
                document.getElementById('intervention-form').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Fonction pour supprimer une intervention
        function deleteIntervention(interventionId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette intervention ?')) {
                interventions = interventions.filter(i => i.id !== interventionId);
                localStorage.setItem('interventions', JSON.stringify(interventions));
                displayRecords();
                updateStatistics();
                showSuccessMessage('Intervention supprim√©e avec succ√®s!');
            }
        }

        // Fonction pour se d√©connecter
        function logout() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                currentUser = null;
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
                
                // R√©initialiser le formulaire d'authentification
                document.getElementById('auth-form').reset();
                
                // R√©initialiser la s√©lection du service
                selectService('');
            }
        }

        // Afficher les enregistrements au chargement
        displayRecords();
    </script>
</body>
</html>
